name:        "MongoDB Atlas Acorn"
description: "Acorn providing a MongoDB Atlas cluster"
readme:      "./README.md"
info:        localData.info
icon:        "./icon.png"

args: {
  // Cloud provider
  provider: "AWS"

  // Cloud provider region
  region: "US_EAST_1"
  
  // Cluster size (only M0 is free)
  tier: "M0"

  // Cluster name
  clusterName: "mytestcluster"

  // Database version
  dbVersion: "6.0"

  // Default database
  dbName: "mydb"

  // Default user
  dbUser: "mytestuser"
}

services: atlas: generated: job: "create-cluster"

jobs: "create-cluster": {
  build: context: "."
  env: {
    MONGODB_ATLAS_PUBLIC_API_KEY: "secret://atlas-creds/public_key"
    MONGODB_ATLAS_PRIVATE_API_KEY: "secret://atlas-creds/private_key"
    MONGODB_ATLAS_PROJECT_ID: "secret://atlas-creds/project_id"
    PROVIDER: args.provider
    REGION: args.region
    TIER: args.tier
    CLUSTER_NAME: args.clusterName
    DB_VERSION: args.dbVersion
    DB_USER: "secret://user/username"
    DB_PASS: "secret://user/password"
    DB_NAME: args.dbName
  }
  events: ["create"]
}

jobs: "delete-cluster": {
  build: {
    context: "."
    buildArgs: {
        action: "delete"
    }
  }
  env: {
    MONGODB_ATLAS_PUBLIC_API_KEY: "secret://atlas-creds/public_key"
    MONGODB_ATLAS_PRIVATE_API_KEY: "secret://atlas-creds/private_key"
    MONGODB_ATLAS_PROJECT_ID: "secret://atlas-creds/project_id"
    CLUSTER_NAME: "secret://state/cluster_name"
    DB_USER: "secret://user/username"
  }
  events: ["delete"]
}

secrets: {
  user: {
    name: "user credentials"
    type: "basic"
    params: {
        usernameLength: 7
        usernameCharacters: "a-z"
        passwordLength: 10
        passwordCharacters: "A-Za-z0-9"
    }
    data: {  
        username: std.ifelse(args.dbUser != "", args.dbUser, "")
        password: ""
    }
  }
}

secrets: {
  "atlas-creds": {
      external: "atlas-creds"
      type: "opaque"
      data: {
          public_key: "MONGODB_ATLAS_PUBLIC_API_KEY"
          private_key: "MONGODB_ATLAS_PRIVATE_API_KEY"
          project_id: "MONGODB_ATLAS_PROJECT_ID"
      }
  }
}

secrets: {
  "state": {
    type: "generated"
    params: job: "create-cluster"
  }
}

localData: info: """
	## Usage

	services: db: {
		image: "ghcr.io/acorn-io/mongodb-atlas:v#.#-#"
	}

	containers: app: {
		image: "app-image"
		env: {
		  DB_HOST:  "@{@{service.}db.address}"
		  DB_PORT:  "@{@{service.}db.port.27017}"
		  DB_NAME:  "@{@{service.}db.data.dbName}"
      DB_PROTO: "@{@{service.}db.data.proto}"
		  DB_USER:  "@{@{service.}db.secrets.user.username}"
		  DB_PASS:  "@{@{service.}db.secrets.user.password}"
		}
	}
	"""